# Задание для школы бэкэнд-разработки Yandex

* [Описание задания](#description)
* [Реализованные обработчики REST API](#handlers)
    * [1. POST /couriers](#post-import-couriers)
    * [2. PATCH /couriers/$courier_id](#patch-edit)
    * [3. POST /orders](#post-import-orders)
    * [4. POST /orders/assign](#post-assign-orders)
    * [5. POST /orders/complete](#post-complete-orders)
    * [6. GET /couriers/$courier_id](#get-courier)
* [Инструкции](#instructions)
    * [Запуск приложения](#launch)
    * [Запуск тестов](#run-tests)


## <a name="description">Описание задания</a>

Чтобы немного скрасить жизнь людей на самоизоляции, вы решаете открыть
интернет-магазин. Задача — разработать на python REST API сервис, который позволит нанимать курьеров на работу,
принимать заказы и оптимально распределять заказы между курьерами, попутно считая их рейтинг и заработок.

## <a name="handlers">Реализованные обработчики REST API</a>

### 1. <a name="post-import-couriers">POST /couriers</a>

Обработчик принимает на вход в формате  json  список с данными о курьерах и графиком их работы.
Курьеры работают только в заранее определенных районах, а так же различаются по типу: пеший, велокурьер и курьер на автомобиле. От типа курьера 
зависит его грузоподъемность — 10 кг, 15 кг и 50 кг соответственно.
Районы задаются целыми положительными числами. График работы задается списком строк формата  HH:MM-HH:MM.

Поле  | Тип | Описание
------------- | ------------- | -------------
courier_id| целое положительное число | Уникальный идентификатор курьера, положительное число. Идентификаторы уникальны в пределах всего сервиса.
courier_type | строка | Тип курьера. Возможные значения: foot — пеший курьер, bike — велокурьер, car — курьер на автомобиле
regions | Массив целых положительных чисел | Список идентификаторов районов, в которых работает курьер.
working_hours | Массив строк | График работы курьера. Формат строки  HH:MM-HH:MM. Есть гарантия на то, что промежутки не будут пересекаться.

Все поля обязательны.

Пример запроса:

    POST /couriers
    {
      "data": [
        {
          "courier_id": 1,
          "courier_type": "foot",
          "regions": [1, 12, 22],
          "working_hours": ["11:35-14:05", "09:00-11:00"]
        },
        {
          "courier_id": 2,
          "courier_type": "bike",
          "regions": [22],
          "working_hours": ["09:00-18:00"]
        },
        {
        
          "courier_id": 3,
          "courier_type": "car",
          "regions": [12, 22, 23, 33],
          "working_hours": []
        },
        ...
      ]
    }
    
В случае, если в наборе есть неописанные поля или какие-либо из полей отсутствуют, то возвращается ошибка HTTP 400 Bad Request  и список id, которые не удалось провалидировать.

    HTTP 400 Bad Request
      {
        "validation_error": {
                            "couriers": [{"id": 2}, {"id": 3}]
                            }
      }
      
В случае успеха возвращается ответ HTTP 201 Created и списком импортированных id.

    HTTP 201 Created
      {
        "couriers": [{"id": 1}, {"id": 2}, {"id": 3}]
      }
    
### 2. <a name="patch-edit">PATCH /couriers/$courier_id</a>

Позволяет изменить информацию о курьере. Принимает  json  и любые поля из списка: courier_type, regions, working_hours. При редактировании также учитываются случаи, когда меняется график и уменьшается грузоподъемность и появляются заказы, которые курьер уже не сможет развести — такие заказы снимаются и доступны для выдачи другим курьерам.

 Пример запроса:
 
    PATCH /couriers/2
      {
        "regions": [11, 33, 2]
      }
    
В случае, если передано неописанное поле возвращается  HTTP 400 Bad Request.

В случае успеха возвращается HTTP 200 OK  и актуальная информация о редактируемом курьере:

    HTTP 200 OK
      {
        "courier_id": 2,
        "courier_type": "foot",
        "regions": [11, 33, 2],
        "working_hours": ["09:00-18:00"]
      }
      
### 3. <a name="post-import-orders">POST /orders</a>

Принимает на вход в формате  json  список с данными о заказах. Заказы характеризуются весом, районом и временем доставки.
      
 Поле  | Тип | Описание
------------- | ------------- | -------------
order_id| целое положительное число | id заказа, уникален в пределах всех заказов сервиса.
weight | Положительное число с плавающей точкой | Вес заказа в кг. 2 значащих разряда после запятой. Значения меньше 0.01 и больше 50 невалидны.
region | Целое положительное число | Район доставки заказа.
delivery_hours | Массив строк | Промежутки, в которые клиенту удобно принять заказ. Формат строки HH:MM-HH:MM. Есть гарантия на то, что промежутки не будут пересекаться.

Все поля обязательны.

Пример запроса:

    POST /orders
      {
        "data": [
          {
            "order_id": 1,
            "weight": 0.23,
            "region": 12,
            "delivery_hours": ["09:00-18:00"]
          },
          {
            "order_id": 2,
            "weight": 15,
            "region": 1,
            "delivery_hours": ["09:00-18:00"]
          },
          {
            "order_id": 3,
            "weight": 0.01,
            "region": 22,
            "delivery_hours": ["09:00-12:00", "16:00-21:30"]
          },
          ...
        ]
      }
     
В случае, если в наборе есть неописанные поля или какие-либо из полей отсутствуют — возвращается ошибка  HTTP
400 Bad Request.

Пример ответа:

    HTTP 400 Bad Request
            {
            "validation_error": {
                "orders": [{"id": 2}, {"id": 3}]
            }
        }

В случае успеха возвращается HTTP 201 Created и список импортированных id.

Пример:

    HTTP 201 Created
    {
        "orders": [{"id": 1}, {"id": 2}, {"id": 3}]
    }

### 4. <a name="post-assign-orders">POST /orders/assign</a>

Принимает id курьера и назначает максимальное количество заказов, подходящих по весу, району и графику работы. Заказы, выданные одному курьеру, не должны быть доступны для выдачи другому.

Если  /orders/assign  вызывается после того, как курьер уже доставил какие-то ранее выданные заказы, то такие
заказы убираются из ответа, а assign_time должен остаться тем же. В  assign_time  должно содержаться время
успешного назначения заказов.

В случае, когда не удалось найти подходящих заказов возвращается пустой спиоск; assign_time не возвращается;

Пример запроса:

    POST /orders/assign
        {
            "courier_id": 2
        }
 
 Пример ответа:
 
    HTTP 200 OK
        {
            "orders": [{"id": 1}, {"id": 2}],
            "assign_time": "2021-01-10T09:32:14.42Z"
        }
        
 В случае, если передан идентификатор несуществующего курьера, возвращается ошибка HTTP 400 Bad Request .
 
 ### 5. <a name="post-complete-orders">POST /orders/complete</a>
 
Принимает 3 параметра: id курьера, id заказа и время выполнения заказа, отмечает заказ выполненным.
В случае, если заказ не найден, был назначен на другого курьера или не назначен вовсе, возвращается ошибка HTTP
400 Bad Request .

В случае успеха —  HTTP 200 OK  и идентификатор завершенного заказа.
Обработчик ялвяется идемпотентным.

Пример запроса:

    POST /orders/complete
        {
            "courier_id": 2,
            "order_id": 33,
            "complete_time": "2021-01-10T10:33:01.42Z"
        }

Пример ответа:

    HTTP 200 OK
        {
            "order_id": 33
        }
 
  ### 6. <a name="get-courier">GET /couriers/$courier_id</a>
  
Возвращает информацию о курьере и дополнительную статистику: рейтинг и заработок.

Пример ответа:

    GET /couriers/2
        {
            "courier_id": 2,
            "courier_type": "foot",
            "regions": [11, 33, 2],
            "working_hours": ["09:00-18:00"],
            "rating": 4.93,
            "earnings": 10000
        }
Рейтинг рассчитывается следующим образом:

        (60*60 - min(t, 60*60))/(60*60) * 5 
 
где  t  - минимальное из средних времен доставки по районам (в секундах), t = min(td[1], td[2],..., td[n]) 
 
td[i] - среднее время доставки заказов по району i (в секундах).
Время доставки одного заказа определяется как разница между временем окончания этого заказа и временем окончания предыдущего заказа (или временем назначения заказов, если вычисляется время для первого заказа).

Если курьер не завершил ни одного развоза, то рейтинг не возвращается.

Заработок рассчитывается как сумма оплаты за каждый завершенный развоз:
 sum = ∑(500 * C),
 
C  — коэффициент, зависящий от типа курьера (пеший — 2, велокурьер — 5, авто — 9) на момент формирования
развоза.

## <a name="instructions">Инструкции</a>

### <a name="launch">Запуск приложения</a>
Находясь в папке с файлом docker-compose.yml выполнить в терминале:

    docker-compose build
    docker-compose up
    
### <a name="run-tests">Запуск тестов</a>

Следующие команды выполняются в терминале, находясь в корневой папке приложения:

##### 1. Установить зависимости для python:

    pip install -r requirements.txt
        
##### 2. Запуск тестов

    python3 manage.py test
